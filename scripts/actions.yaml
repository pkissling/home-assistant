---

good_night_google_assistant:
  mode: restart
  # Dim bedroom light down, if on
  sequence:
    - choose:
        - conditions:
            - condition: state
              entity_id: light.bedroom_wardrobe
              state: 'on'
          sequence:
            - service: light.turn_on
              entity_id: light.bedroom_wardrobe
              data:
                brightness: 50
                transition: 120  # 2 min
    - service: media_player.turn_off
      entity_id: media_player.lg_webos_smart_tv
    - service: input_boolean.turn_off
      entity_id: input_boolean.home_office_mode
    - service: switch.turn_off
      entity_id: switch.remote_off
    - wait_for_trigger:
        platform: state
        entity_id: media_player.bedroom
        to: 'off'
      continue_on_timeout: false
      timeout: '0:15:00'
    - choose:
        - conditions:
            - condition: state
              entity_id: group.window_all
              state: 'on'
            - condition: state
              entity_id: input_boolean.summer_mode
              state: 'off'
          sequence:
            service: notify.google_assistant_sdk
            data:
              target: Bedroom
              message: >
                Windows are open in:
                {{
                  expand('group.window_all')
                  | selectattr('state', 'eq', 'on')
                  | map(attribute='name')
                  | join(',')
                  | replace('Window', '')
                }}
    - choose:
        - conditions:
            condition: state
            entity_id: switch.alarm
            state: 'on'
          sequence:
            service: notify.google_assistant_sdk
            data:
              target: Bedroom
              message: >
                The alarm is set to
                {{ state_attr('input_datetime.wakeup_time', 'hour') }}
                {{ state_attr('input_datetime.wakeup_time', 'minute') }}.
                Good night!
      default:
        service: notify.google_assistant_sdk
        data:
          target: Bedroom
          message: "No alarm set for tomorrow. Good night!"
    - service: script.lights_ambient_turn_off
      data:
        transition: 300  # 5 min
    - delay: 300  # 5 mins

good_night:
  mode: restart
  sequence:
    - service: media_player.turn_off
      entity_id: media_player.lg_webos_smart_tv
    - service: input_boolean.turn_off
      entity_id: input_boolean.home_office_mode
    - service: switch.turn_off
      entity_id: switch.remote_off
    - choose:
        - conditions:
            - condition: state
              entity_id: group.window_all
              state: 'on'
            - condition: state
              entity_id: input_boolean.summer_mode
              state: 'off'
            - condition: state
              entity_id: switch.guest_mode
              state: 'off'
          sequence:
            service: mqtt.publish
            data:
              topic: wallpanel/corridor/command
              payload: >
                {%
                  set open_windows =  expand('group.window_all')
                  | selectattr('state', 'eq', 'on')
                  | map(attribute='name')
                  | join(',')
                  | replace('Window', '')
                %}
                {"speak":"Windows open in {{ open_windows }}"}
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.guest_mode
              state: 'off'
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: switch.alarm
                      state: 'on'
                  sequence:
                    service: mqtt.publish
                    data:
                      topic: wallpanel/corridor/command
                      payload: >
                        {
                          "speak":" The alarm is set to
                          {{ state_attr('input_datetime.wakeup_time', 'hour') }}
                          {{ state_attr('input_datetime.wakeup_time', 'minute') }}.
                          Good night!"
                        }
              default:
                service: mqtt.publish
                data:
                  topic: wallpanel/corridor/command
                  payload: >
                    { "speak":" No alarm is set for tomorrow. Good night!" }
    - choose:
        - conditions:
            - condition: state
              entity_id: light.bedroom_wardrobe
              state: 'off'
          sequence:
            - service: light.turn_on
              entity_id: light.bedroom_wardrobe
              data:
                brightness: 10
                transition: 10
            - delay: 10
    - choose:
        - conditions:
            - condition: state
              entity_id: light.study_floor_lamp
              state: 'on'
            - condition: state
              entity_id: switch.guest_mode
              state: 'off'
          sequence:
            - service: light.turn_off
              entity_id: light.study_floor_lamp
              data:
                transition: 120  # 2 mins
    - service: script.lights_ambient_turn_off
      data:
        transition: 120  # 2 min
    - delay: 120  # 2 mins

good_morning:
  mode: restart
  sequence:
    - service: script.lights_ambient_turn_on
      data:
        transition: 10
    # Wait some seconds until news is being read
    - delay: 30  # seconds
    - wait_for_trigger:
        - platform: state
          entity_id: media_player.bedroom
          to: idle
        - platform: state
          entity_id: media_player.all_speakers
          to: idle
        - platform: state
          entity_id: media_player.bathroom
          to: idle
      timeout: '00:10:00'
    - service: media_player.turn_off
      entity_id: all
    - service: switch.turn_on
      entity_id: switch.radio_puls

im_leaving:
  mode: restart
  sequence: []
